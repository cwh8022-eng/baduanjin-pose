<script>
  document.getElementById('tfjs-version').innerText = tf.version.tfjs;

  const MODEL_URL = "https://teachablemachine.withgoogle.com/models/jX4OKw-11/";
  let model, webcam, ctx, labelContainer, maxPredictions;

  async function init() {
    try {
      const modelURL = MODEL_URL + "model.json";
      const metadataURL = MODEL_URL + "metadata.json";

      model = await tmPose.load(modelURL, metadataURL);
      maxPredictions = model.getTotalClasses();

      const size = 400;
      webcam = new tmPose.Webcam(size, size, true);
      await webcam.setup();
      await webcam.play();
      window.requestAnimationFrame(loop);

      const canvas = document.getElementById('canvas');
      canvas.width = size;
      canvas.height = size;
      ctx = canvas.getContext('2d');

      labelContainer = document.getElementById('label-container');
      labelContainer.innerHTML = "";
      for (let i = 0; i < maxPredictions; i++) {
        labelContainer.appendChild(document.createElement('div'));
      }
    } catch (err) {
      console.error("初始化錯誤：", err);
      alert("載入模型或攝影機失敗，請確認模型網址正確並使用支援的瀏覽器。");
    }
  }

  async function loop() {
    webcam.update();
    await predict();
    window.requestAnimationFrame(loop);
  }

  async function predict() {
    const { pose, posenetOutput } = await model.estimatePose(webcam.canvas);
    const prediction = await model.predict(posenetOutput);

    ctx.drawImage(webcam.canvas, 0, 0);
    tmPose.drawPose(pose, ctx);

    for (let i = 0; i < maxPredictions; i++) {
      const p = prediction[i];
      labelContainer.childNodes[i].innerText = `${p.className}: ${(p.probability * 100).toFixed(2)}%`;
    }
  }
</script>
