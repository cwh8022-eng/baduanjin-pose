<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>八段錦診斷頁（不開 Console）</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f6f8fb;margin:0;padding:24px}
    h1{margin:0 0 12px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:16px;margin:12px 0}
    .ok{color:#16a34a}.bad{color:#dc2626}.warn{color:#ca8a04}
    code{background:#f1f5f9;padding:2px 6px;border-radius:6px}
    button{padding:8px 14px;border:0;border-radius:8px;background:#2563eb;color:#fff;cursor:pointer}
    ul{margin:6px 0 0 18px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;word-break:break-all}
  </style>

  <!-- 僅載 tfjs 1.7.4；先不載 tmPose -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.7.4/dist/tf.min.js"></script>
</head>
<body>
  <h1>八段錦診斷頁（不開 Console 版）</h1>

  <div class="card">
    <b>環境</b>
    <div id="env"></div>
  </div>

  <div class="card">
    <b>TensorFlow.js 狀態</b>
    <div id="tfinfo"></div>
  </div>

  <div class="card">
    <b>已載入的 <code>&lt;script&gt;</code> 列表</b>
    <div id="scripts" class="mono"></div>
  </div>

  <div class="card">
    <b>相機自檢</b><br>
    <button id="btnCam">測試 getUserMedia</button>
    <div id="cam" style="margin-top:8px"></div>
  </div>

  <div class="card">
    <b>載入 tmPose 測試（按下才會載）</b><br>
    <button id="btnTm">載入 tmPose 並測試 fromPixels</button>
    <div id="tm" style="margin-top:8px"></div>
  </div>

  <div class="card">
    <b>說明</b>
    <ul>
      <li>若「tfjs 版本」不是 <code>1.7.4</code> 或「fromPixels」顯示 <code>false</code>，代表被其它外掛/腳本覆蓋。</li>
      <li>若按「載入 tmPose」後顯示錯誤文字，那就是 tmPose 與目前 TFJS 不相容（會把錯誤顯示出來）。</li>
    </ul>
  </div>

<script>
(function(){
  const $ = id => document.getElementById(id);
  const envEl = $('env'), tfEl = $('tfinfo'), scEl = $('scripts'), camEl=$('cam'), tmEl=$('tm');

  // === 顯示環境 ===
  const secure = window.isSecureContext;
  envEl.innerHTML = `SecureContext：<b class="${secure?'ok':'bad'}">${secure}</b>（需為 HTTPS 或 localhost）`;

  // === 顯示 TFJS 狀態 ===
  function renderTF() {
    const v = (window.tf && tf.version && tf.version.tfjs) || '未載';
    const hasFP = (window.tf && typeof tf.fromPixels === 'function');
    tfEl.innerHTML = `tfjs 版本：<b>${v}</b>　fromPixels：<b class="${hasFP?'ok':'bad'}">${hasFP}</b>`;
  }
  // 若沒有舊 API，就從 browser 版映射一次
  (function ensureFromPixels(){
    if (window.tf && typeof tf.fromPixels !== 'function' &&
        tf.browser && typeof tf.browser.fromPixels === 'function') {
      try { Object.defineProperty(tf,'fromPixels',{value:tf.browser.fromPixels.bind(tf.browser),writable:false,configurable:false}); }
      catch(_) { tf.fromPixels = tf.browser.fromPixels.bind(tf.browser); }
    }
  })();
  renderTF();

  // === 列出所有 script src ===
  const list = Array.from(document.scripts).map(s=>s.src).filter(Boolean);
  scEl.innerHTML = list.length ? ('<ul>'+list.map(x=>`<li>${x}</li>`).join('')+'</ul>') : '<i>（無外部 script）</i>';

  // === 相機自檢 ===
  $('btnCam').onclick = async ()=>{
    camEl.textContent = '測試中…';
    try{
      if(!secure) throw new Error('非 HTTPS/localhost，瀏覽器會封鎖相機');
      const st = await navigator.mediaDevices.getUserMedia({video:true,audio:false});
      st.getTracks().forEach(t=>t.stop());
      camEl.innerHTML = '<span class="ok">✅ 相機可用</span>';
    }catch(e){
      camEl.innerHTML = `<span class="bad">❌ 相機錯誤：${e.name} — ${e.message||e}</span>`;
    }
  };

  // === 動態載入 tmPose 並測試 ===
  $('btnTm').onclick = async ()=>{
    tmEl.textContent = '載入中…';
    try{
      await new Promise((res,rej)=>{
        if (window.tmPose) return res();
        const s=document.createElement('script');
        s.src='https://cdn.jsdelivr.net/npm/@teachablemachine/pose@0.8/dist/teachablemachine-pose.min.js';
        s.onload=()=>res();
        s.onerror=()=>rej(new Error('teachablemachine-pose 載入失敗'));
        document.head.appendChild(s);
      });
      // 這一步只測「tmPose 載入是否會因 fromPixels 故障」
      if (typeof tf.fromPixels !== 'function') {
        throw new Error('tf.fromPixels 不存在（tmPose 需要 1.x 舊 API），代表仍被其它腳本覆蓋。');
      }
      tmEl.innerHTML = '<span class="ok">✅ tmPose 載入成功，fromPixels 可用</span>';
    }catch(e){
      tmEl.innerHTML = `<span class="bad">❌ tmPose 失敗：${e.message||e}</span>`;
    }
  };
})();
</script>
</body>
</html>
