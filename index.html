<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>八段錦辨識（單檔・隔離＋放寬CSP）</title>

  <!-- 放寬外層 CSP：允許 inline script，避免內嵌程式被擋 -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net;
                 connect-src 'self' https://teachablemachine.withgoogle.com https://storage.googleapis.com https://cdn.jsdelivr.net;
                 img-src 'self' data:;
                 style-src 'self' 'unsafe-inline';
                 media-src *;
                 frame-ancestors 'self';">

  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,Arial,Helvetica,sans-serif;
         background:#f6f8fb;margin:0;padding:24px;text-align:center}
    h1{margin:6px 0 10px}
    #wrap{max-width:980px;margin:0 auto}
    #err{color:#c0392b;font-weight:700;margin:8px 0}
    iframe{width:100%;height:720px;border:2px solid #2c3e50;border-radius:12px;background:#fff}
    .tips{color:#666;font-size:13px;margin-top:8px}
  </style>
</head>
<body>
<div id="wrap">
  <h1>八段錦動作辨識（沙箱隔離，避免 TFJS 衝突）</h1>
  <div id="err"></div>

  <!-- 允許相機；保留 allow-same-origin 讓模型可下載；仍依靠 CSP 限制來源 -->
  <iframe id="runner"
          sandbox="allow-scripts allow-same-origin allow-forms allow-pointer-lock allow-modals"
          allow="camera *; microphone *"
          referrerpolicy="no-referrer"></iframe>

  <p class="tips">
    請在 <b>HTTPS</b> 或 <b>localhost</b> 開啟，按「啟動辨識」並允許相機。<br>
    若有外掛干擾，請用 <b>訪客模式</b> 或無痕視窗（外掛勿允許在無痕執行）。
  </p>
</div>

<script>
  // 你的 Teachable Machine 模型 ID（可自行更換）
  const TM_MODEL_ID = "jX4OKw-11";
  const MODEL_URL = `https://teachablemachine.withgoogle.com/models/${TM_MODEL_ID}/`;

  // ★ 內頁也加上允許 inline 的 CSP，避免「Refused to execute inline script」
  const innerCSP = `
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net;
                 connect-src 'self' https://teachablemachine.withgoogle.com https://storage.googleapis.com https://cdn.jsdelivr.net;
                 img-src 'self' data:;
                 style-src 'self' 'unsafe-inline';
                 media-src *;">`;

  const srcdoc = `<!DOCTYPE html>
<html lang='zh-Hant'>
<head>
<meta charset='utf-8'/>
<meta name='viewport' content='width=device-width,initial-scale=1'/>
<title>Runner</title>
${innerCSP}
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,Arial,Helvetica,sans-serif;
       background:#fff;margin:0;padding:16px;text-align:center}
  #ver{color:#666;margin:6px 0 10px}
  #err{color:#c0392b;font-weight:700;margin:8px 0}
  canvas{border:2px solid #2c3e50;border-radius:10px}
  #labels div{font-size:16px;margin-top:6px}
  button{margin:10px 0 14px;padding:10px 18px;font-size:16px;background:#2980b9;color:#fff;border:0;border-radius:6px;cursor:pointer}
</style>
</head>
<body>
  <h3>八段錦辨識（沙箱內執行）</h3>
  <div id="ver">初始化中…</div>
  <div id="err"></div>
  <button id="start">啟動辨識</button><br>
  <canvas id="c" width="400" height="400"></canvas>
  <div id="labels"></div>

  <!-- 固定相容版本：tfjs 1.7.4 + tmPose 0.8 -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.7.4/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/pose@0.8/dist/teachablemachine-pose.min.js"></script>

  <script>
  (function(){
    const MODEL = "${MODEL_URL}";
    let model, webcam, ctx, labels, maxPred;

    // 顯示版本與 fromPixels 狀態（1.7.4 應為 function）
    (function(){
      const v = (window.tf && tf.version && tf.version.tfjs) ? tf.version.tfjs : "未載入";
      const has = (typeof tf.fromPixels === "function");
      document.getElementById('ver').textContent = 'tfjs 版本：' + v + '；tf.fromPixels = ' + has;
    })();

    document.getElementById('start').onclick = init;

    async function init(){
      const errEl = document.getElementById('err'); errEl.textContent = '';
      try{
        // 1) backend
        try{ await tf.setBackend('webgl'); }catch{ await tf.setBackend('cpu'); }
        await tf.ready();
        if(typeof tf.fromPixels !== 'function'){
          throw new Error('tf.fromPixels 不可用（沙箱內不應發生）');
        }

        // 2) 載入模型
        model = await tmPose.load(MODEL + 'model.json', MODEL + 'metadata.json');
        maxPred = model.getTotalClasses();

        // 3) 啟用相機
        const size = 400;
        webcam = new tmPose.Webcam(size, size, true);
        await webcam.setup();
        await webcam.play();
        requestAnimationFrame(loop);

        // 4) 畫布/標籤
        const canvas = document.getElementById('c');
        ctx = canvas.getContext('2d');
        labels = document.getElementById('labels'); labels.innerHTML='';
        for(let i=0;i<maxPred;i++){ labels.appendChild(document.createElement('div')); }

      }catch(e){
        console.error(e);
        errEl.textContent = '⚠️ 無法啟動：' + e.message + '（請確認 HTTPS/localhost 並允許相機）';
      }
    }

    async function loop(){
      webcam.update();
      await predict();
      requestAnimationFrame(loop);
    }

    async function predict(){
      const { pose, posenetOutput } = await model.estimatePose(webcam.canvas);
      const pred = await model.predict(posenetOutput);

      ctx.drawImage(webcam.canvas, 0, 0);
      if(pose){
        tmPose.drawKeypoints(pose.keypoints, 0.5, ctx);
        tmPose.drawSkeleton(pose.keypoints, 0.5, ctx);
      }
      for(let i=0;i<pred.length;i++){
        labels.childNodes[i].textContent =
          pred[i].className + ': ' + (pred[i].probability*100).toFixed(2) + '%';
      }
    }
  })();
  </script>
</body>
</html>`;

  document.getElementById('runner').srcdoc = srcdoc;
</script>
</body>
</html>
