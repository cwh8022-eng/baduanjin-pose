<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å…«æ®µéŒ¦è¾¨è­˜ï¼ˆç›¸æ©Ÿè‡ªæª¢ãƒ»å–®æª”éš”é›¢ï¼‰</title>

  <!-- æ”¾å¯¬å¤–å±¤ CSP ä»¥å…è¨±å…§åµŒ scriptï¼ˆåƒ…æ­¤é ï¼‰ -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net;
                 connect-src 'self' https://teachablemachine.withgoogle.com https://storage.googleapis.com https://cdn.jsdelivr.net;
                 img-src 'self' data:;
                 style-src 'self' 'unsafe-inline';
                 media-src *;">

  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,Arial,Helvetica,sans-serif;
         background:#f6f8fb;margin:0;padding:24px;text-align:center}
    h1{margin:6px 0 10px}
    #wrap{max-width:980px;margin:0 auto}
    #err{color:#c0392b;font-weight:700;margin:8px 0;white-space:pre-line}
    iframe{width:100%;height:760px;border:2px solid #2c3e50;border-radius:12px;background:#fff}
    .tips{color:#666;font-size:13px;margin-top:8px}
  </style>
</head>
<body>
<div id="wrap">
  <h1>å…«æ®µéŒ¦å‹•ä½œè¾¨è­˜ï¼ˆç›¸æ©Ÿè‡ªæª¢ â†’ ç›¸å®¹è¼‰å…¥ï¼‰</h1>
  <div id="err"></div>

  <!-- é—œéµï¼šä¸çµ¦ allow-same-originï¼Œé¿å…å¤–å±¤å¹²æ“¾ï¼›æ˜ç¢ºå…è¨± camera/microphone -->
  <iframe id="runner"
          sandbox="allow-scripts allow-forms allow-pointer-lock allow-modals"
          allow="camera; microphone"
          referrerpolicy="no-referrer"></iframe>

  <p class="tips">
    è«‹åœ¨ <b>HTTPS</b> æˆ– <b>localhost</b> é–‹å•Ÿã€‚æŒ‰ã€Œå•Ÿå‹•è¾¨è­˜ã€å¾Œï¼Œé»ã€Œå…è¨±ã€ç›¸æ©Ÿã€‚<br>
    è‹¥ä»å¤±æ•—ï¼šç”¨ <b>è¨ªå®¢æ¨¡å¼</b>ï¼ˆä¸æ˜¯ç„¡ç—•ï¼‰é‡è©¦ï¼Œæˆ–åœ¨ç¶²å€åˆ—å·¦é‚Šçš„ğŸ”’æª¢æŸ¥ã€Œç›¸æ©Ÿã€æ¬Šé™ã€‚
  </p>
</div>

<script>
  // æ”¹æˆä½ çš„ TM æ¨¡å‹ ID
  const TM_MODEL_ID = "jX4OKw-11";
  const MODEL_URL = `https://teachablemachine.withgoogle.com/models/${TM_MODEL_ID}/`;

  // å…§é ï¼ˆsrcdocï¼‰ï¼šå…ˆåšç›¸æ©Ÿè‡ªæª¢ï¼ŒæˆåŠŸæ‰è¼‰ tfjs 1.7.4 + tmPose 0.8 + æ¨¡å‹
  const inner = `<!DOCTYPE html>
<html lang='zh-Hant'>
<head>
<meta charset='utf-8'/>
<meta name='viewport' content='width=device-width,initial-scale=1'/>
<title>Runner</title>
<meta http-equiv="Content-Security-Policy"
      content="default-src 'self';
               script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net;
               connect-src 'self' https://teachablemachine.withgoogle.com https://storage.googleapis.com https://cdn.jsdelivr.net;
               img-src 'self' data:;
               style-src 'self' 'unsafe-inline';
               media-src *;">
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,Arial,Helvetica,sans-serif;
       background:#fff;margin:0;padding:16px;text-align:center}
  #ver{color:#666;margin:6px 0 10px}
  #err{color:#c0392b;font-weight:700;margin:8px 0;white-space:pre-line}
  video,canvas{border:2px solid #2c3e50;border-radius:10px}
  #labels div{font-size:16px;margin-top:6px}
  button{margin:10px 0 14px;padding:10px 18px;font-size:16px;background:#2980b9;color:#fff;border:0;border-radius:6px;cursor:pointer}
  .ok{color:#27ae60}
</style>
</head>
<body>
  <h3>å…«æ®µéŒ¦è¾¨è­˜ï¼ˆæ²™ç®±å…§åŸ·è¡Œï¼‰</h3>
  <div id="ver">åˆå§‹åŒ–ä¸­â€¦</div>
  <div id="err"></div>

  <button id="check">â‘  ç›¸æ©Ÿè‡ªæª¢</button>
  <button id="start" disabled>â‘¡ è¼‰å…¥æ¨¡å‹ä¸¦é–‹å§‹</button><br>

  <video id="probe" playsinline muted autoplay style="width:320px;height:240px;display:none;"></video>
  <canvas id="c" width="400" height="400" style="display:none;"></canvas>
  <div id="labels"></div>

  <script>
  const MODEL = "${MODEL_URL}";
  let model, webcam, ctx, labels, maxPred, streamOK = false;

  const verEl = document.getElementById('ver');
  const errEl = document.getElementById('err');
  const probe = document.getElementById('probe');
  const startBtn = document.getElementById('start');
  const checkBtn = document.getElementById('check');

  // é¡¯ç¤ºåŸ·è¡Œç’°å¢ƒ
  verEl.textContent = (location.protocol === 'https:' || location.hostname === 'localhost')
    ? 'ç’°å¢ƒæª¢æŸ¥ï¼šâœ… Secure context (HTTPS/localhost)'
    : 'ç’°å¢ƒæª¢æŸ¥ï¼šâŒ é HTTPS/localhostï¼Œç€è¦½å™¨æœƒå°é–ç›¸æ©Ÿ';

  // â‘  ç›¸æ©Ÿè‡ªæª¢
  checkBtn.onclick = async () => {
    errEl.textContent = '';
    try{
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        throw new Error('æ­¤ç’°å¢ƒä¸æ”¯æ´ getUserMediaï¼Œè«‹æ”¹ Chrome/Edgeï¼Œä¸¦åœ¨ HTTPS/localhost é–‹å•Ÿã€‚');
      }
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio:false });
      probe.srcObject = stream;
      probe.onloadedmetadata = () => probe.play();
      probe.style.display = 'inline-block';
      streamOK = true;
      startBtn.disabled = false;
      checkBtn.textContent = 'â‘  ç›¸æ©Ÿè‡ªæª¢ï¼ˆâœ… é€šéï¼‰';
      checkBtn.classList.add('ok');
    }catch(e){
      const msg = e && e.name ? e.name : 'Unknown';
      errEl.textContent =
        'ç›¸æ©Ÿè‡ªæª¢å¤±æ•—ï¼š' + msg + '\\n' +
        'â€¢ è‹¥æ˜¯ NotAllowedErrorï¼šä»£è¡¨ä½ æŒ‰äº†æ‹’çµ•ï¼Œæˆ–ç«™é»æ¬Šé™è¢«é—œé–‰ã€‚\\n' +
        'â€¢ è‹¥æ˜¯ NotFoundErrorï¼šæ²’æœ‰å¯ç”¨æ”å½±æ©Ÿã€‚\\n' +
        'â€¢ è«‹ç¢ºèª HTTPS/localhostã€é‡æ–°è¼‰å…¥å¾Œå…è¨±ç›¸æ©Ÿã€‚';
      startBtn.disabled = true;
    }
  };

  // å‹•æ…‹è¼‰å…¥ script
  function loadScript(src){
    return new Promise((res,rej)=>{
      const s=document.createElement('script');
      s.src = src + (src.includes('?')?'&':'?') + 'cb=' + Date.now();
      s.onload=()=>res();
      s.onerror=()=>rej(new Error('è¼‰å…¥å¤±æ•—ï¼š'+src));
      document.head.appendChild(s);
    });
  }

  // â‘¡ è¼‰å…¥ TF èˆ‡æ¨¡å‹ä¸¦é–‹å§‹
  startBtn.onclick = async () => {
    errEl.textContent='';
    if(!streamOK){ errEl.textContent='è«‹å…ˆåŸ·è¡Œã€Œâ‘  ç›¸æ©Ÿè‡ªæª¢ã€ä¸¦å…è¨±ç›¸æ©Ÿ'; return; }

    try{
      await loadScript('https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.7.4/dist/tf.min.js');
      await loadScript('https://cdn.jsdelivr.net/npm/@teachablemachine/pose@0.8/dist/teachablemachine-pose.min.js');

      verEl.textContent = 'tfjs ç‰ˆæœ¬ï¼š' + (tf && tf.version && tf.version.tfjs ? tf.version.tfjs : 'æœªè¼‰') +
                          'ï¼›tf.fromPixels = ' + (typeof tf.fromPixels);

      if(typeof tf.fromPixels !== 'function'){
        throw new Error('tf.fromPixels ä¸å¯ç”¨ï¼ˆè‹¥ä½ æ”¹æª”æ¡ˆï¼Œè«‹ç¶­æŒ tfjs@1.7.4ï¼‰');
      }

      // backend
      try { await tf.setBackend('webgl'); } catch { await tf.setBackend('cpu'); }
      await tf.ready();

      // é‡‹æ”¾è‡ªæª¢ä¸²æµï¼ˆè®“ tmPose ä½¿ç”¨è‡ªå·±çš„ Webcamï¼‰
      if (probe.srcObject) {
        probe.srcObject.getTracks().forEach(t=>t.stop());
        probe.srcObject = null;
        probe.style.display = 'none';
      }

      // è¼‰å…¥æ¨¡å‹
      model = await tmPose.load(MODEL + 'model.json', MODEL + 'metadata.json');
      maxPred = model.getTotalClasses();

      // å•Ÿç”¨ tmPose çš„ Webcam
      const canvas = document.getElementById('c');
      canvas.style.display='inline-block';
      const size = 400;
      webcam = new tmPose.Webcam(size, size, true);
      await webcam.setup();
      await webcam.play();
      ctx = canvas.getContext('2d');
      labels = document.getElementById('labels'); labels.innerHTML='';
      for(let i=0;i<maxPred;i++){ labels.appendChild(document.createElement('div')); }

      requestAnimationFrame(loop);
      startBtn.textContent = 'â‘¡ å·²é–‹å§‹ï¼ˆå†æ¬¡é»æ“Šå¯é‡å•Ÿï¼‰';
    }catch(e){
      console.error(e);
      errEl.textContent = 'å•Ÿå‹•å¤±æ•—ï¼š' + (e.message || e.toString());
    }
  };

  async function loop(){
    webcam.update();
    await predict();
    requestAnimationFrame(loop);
  }

  async function predict(){
    const { pose, posenetOutput } = await model.estimatePose(webcam.canvas);
    const pred = await model.predict(posenetOutput);

    ctx.drawImage(webcam.canvas, 0, 0);
    if(pose){
      tmPose.drawKeypoints(pose.keypoints, 0.5, ctx);
      tmPose.drawSkeleton(pose.keypoints, 0.5, ctx);
    }
    for(let i=0;i<pred.length;i++){
      labels.childNodes[i].textContent =
        pred[i].className + ': ' + (pred[i].probability*100).toFixed(2) + '%';
    }
  }
  <\/script>
</body>
</html>`;

  document.getElementById('runner').srcdoc = inner;
</script>
</body>
</html>
