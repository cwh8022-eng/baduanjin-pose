<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>八段錦診斷版</title>

  <!-- 鎖定相容版本 + 加 bust 參數避免快取 -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.9.0/dist/tf.min.js?v=tf390"></script>
  <script>
    // 顯示所有 script，看看是否有第二個 tfjs
    window.addEventListener('DOMContentLoaded', () => {
      const list = Array.from(document.scripts).map(s => s.src).filter(Boolean);
      console.log('Loaded scripts:', list);
      document.getElementById('scripts').textContent = list.join('\n');
    });
    // 檢查 tfjs 版本 & fromPixels
    window.addEventListener('load', () => {
      const ver = (window.tf && tf.version && tf.version.tfjs) ? tf.version.tfjs : '未載入';
      const ok = !!(tf && tf.browser && typeof tf.browser.fromPixels === 'function');
      document.getElementById('ver').textContent = `tfjs 版本：${ver}；fromPixels：${ok ? 'OK' : '缺失'}`;
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/pose@0.8/dist/teachablemachine-pose.min.js?v=tm08"></script>

  <style>
    body { font-family: Arial, sans-serif; background:#f5f7fa; padding:16px; text-align:center; }
    #ver { color:#2c3e50; margin:8px 0; font-weight:600; }
    #err { color:#c0392b; margin:8px 0; font-weight:700; }
    pre { text-align:left; background:#fff; padding:10px; border:1px solid #ddd; max-width:900px; margin:12px auto; overflow:auto; }
    canvas { border:2px solid #2c3e50; margin-top:14px; }
    button { margin-top:12px; padding:10px 18px; background:#2980b9; color:#fff; border:none; border-radius:6px; cursor:pointer; }
  </style>
</head>
<body>
  <h1>八段錦極簡辨識（診斷版）</h1>
  <div id="ver">檢查中…</div>
  <div id="err"></div>
  <button id="start">啟動辨識</button>
  <br/>
  <canvas id="canvas" width="400" height="400"></canvas>
  <div id="labels"></div>

  <h3>本頁已載入的 script：</h3>
  <pre id="scripts"></pre>

  <script>
    const MODEL = "https://teachablemachine.withgoogle.com/models/jX4OKw-11/";
    let model, webcam, ctx, labels, maxPredictions;

    document.getElementById('start').onclick = init;

    function assertEnv() {
      if (!window.tmPose) throw new Error('tmPose 未載入（請確認 0.8 UMD 並在 tfjs 之後載入）');
      if (!tf.browser || typeof tf.browser.fromPixels !== 'function') {
        throw new Error('tf.browser.fromPixels 不可用（表示 tfjs 版本被覆蓋或快取未清；請用無痕視窗/強制重整）');
      }
      if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
        console.warn('非 HTTPS/localhost：瀏覽器可能拒絕攝影機。');
      }
    }

    async function init() {
      const $err = document.getElementById('err');
      $err.textContent = '';
      try {
        assertEnv();

        const modelURL = MODEL + 'model.json';
        const metadataURL = MODEL + 'metadata.json';
        model = await tmPose.load(modelURL, metadataURL);
        maxPredictions = model.getTotalClasses();

        const size = 400;
        webcam = new tmPose.Webcam(size, size, true);
        await webcam.setup();
        await webcam.play();
        requestAnimationFrame(loop);

        const canvas = document.getElementById('canvas');
        ctx = canvas.getContext('2d');

        labels = document.getElementById('labels');
        labels.innerHTML = '';
        for (let i = 0; i < maxPredictions; i++) {
          labels.appendChild(Object.assign(document.createElement('div'), {id:'lab'+i}));
        }
      } catch (e) {
        console.erro
