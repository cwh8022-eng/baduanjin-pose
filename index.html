<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>八段錦動作辨識</title>
  <style>
    :root{color-scheme:light dark}
    body{font-family:Arial,Helvetica,sans-serif;background:#f0f4f8;margin:0;padding:20px;text-align:center}
    h1{color:#2c3e50;margin:6px 0 12px}
    #ver{color:#555;margin:4px 0 12px}
    #msg{margin:8px 0 14px;font-weight:700;white-space:pre-line}
    .ok{color:#16a34a}.bad{color:#dc2626}.warn{color:#b45309}
    .btn{margin:8px 6px;padding:10px 16px;font-size:15px;border:0;border-radius:8px;background:#2563eb;color:#fff;cursor:pointer}
    .btn.secondary{background:#6b7280}
    .wrap{max-width:1100px;margin:0 auto;display:grid;grid-template-columns:420px 1fr;gap:16px;align-items:start}
    canvas{display:block;margin:0 auto;border:2px solid #2c3e50;border-radius:12px;background:#000}
    video{position:absolute;left:-9999px;top:-9999px;width:0;height:0}
    .panel{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:12px 14px;text-align:left}
    .title{font-size:14px;color:#6b7280;margin:0 0 8px}
    #topClass{font-size:20px;font-weight:800;color:#1f2937;margin:8px 0}
    .bar{display:flex;align-items:center;gap:10px;margin:8px 0}
    .bar-name{width:220px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:#1f2937}
    .bar-track{flex:1;height:14px;background:#e5e7eb;border-radius:999px;overflow:hidden}
    .bar-fill{height:100%;width:0%;background:#10b981;transition:width .12s linear}
    .bar-pct{width:72px;text-align:right;color:#374151;font-variant-numeric:tabular-nums}
    .note{font-size:13px;color:#6b7280;margin-top:6px}
    .dbg{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:13px;background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:10px;margin-top:10px;white-space:pre-wrap}
    .beat{display:inline-block;width:10px;height:10px;border-radius:50%;background:#10b981;margin-left:6px;box-shadow:0 0 0 0 rgba(16,185,129,0.7);animation:pulse 1s infinite}
    @keyframes pulse{0%{transform:scale(.95);box-shadow:0 0 0 0 rgba(16,185,129,.7)}70%{transform:scale(1);box-shadow:0 0 0 8px rgba(16,185,129,0)}100%{transform:scale(.95);box-shadow:0 0 0 0 rgba(16,185,129,0)}}
    @media (max-width:900px){.wrap{grid-template-columns:1fr}}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.11.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/posenet@2.2.1/dist/posenet.min.js"></script>
</head>
<body>
  <h1>八段錦動作辨識 <span id="beat" class="beat" title="推論心跳" style="visibility:hidden;"></span></h1>
  <div id="ver">初始化中…</div>
  <button id="btnCheck" class="btn">① 相機自檢</button>
  <button id="btnStart" class="btn">② 載入模型並開始</button>
  <button id="btnFlip" class="btn secondary" title="前鏡頭通常需鏡像">切換鏡像：開</button>
  <button id="btnCamFacing" class="btn secondary" title="切換前/後鏡頭">鏡頭：前</button>
  <div id="msg"></div>
  <div class="wrap">
    <canvas id="canvas" width="400" height="400"></canvas>
    <div>
      <div class="panel">
        <p class="title">即時辨識結果</p>
        <div id="topClass">尚未開始</div>
        <div id="bars"></div>
        <div id="labelWarn" class="note"></div>
        <div id="qualityNote" class="note"></div>
      </div>
      <div class="panel">
        <p class="title">除錯面板（自動更新）</p>
        <div id="debug" class="dbg">等待開始…</div>
      </div>
    </div>
  </div>
  <video id="video" playsinline autoplay muted></video>

<script>
(function(){
  // --- 參數區 ---
  const DESIRED_8 = [
    '雙手托天理三焦', '左右開弓似射鵰', '調理脾胃須單舉',
    '五勞七傷往後瞧', '搖頭擺尾去心火', '兩手攀足固腎腰',
    '攢拳怒目增氣力', '背後七顛百病消'
  ];
  const MODEL_URL = './model.json';
  const METADATA_URL = './metadata.json';
  const PNET_CFG = { architecture:'MobileNetV1', outputStride:16, inputResolution:{width:257,height:257}, multiplier:0.75 };
  const SMOOTH_ALPHA = 0.2;
  const LOCK_FRAMES = 6;
  const MIN_KP_SCORE = 0.25;
  const SKIP_MSG_COOLDOWN = 30;

  // --- DOM 元素快取 ---
  const D = {
    $: id => document.getElementById(id),
    cssId: n => n.replace(/\s+/g,'-').replace(/[^-\w]/g,'')
  };
  const uiElements = {
    ver: D.$('ver'), msg: D.$('msg'), video: D.$('video'), canvas: D.$('canvas'),
    dbg: D.$('debug'), bars: D.$('bars'), beat: D.$('beat'),
    btnCheck: D.$('btnCheck'), btnStart: D.$('btnStart'), btnFlip: D.$('btnFlip'),
    btnCamFacing: D.$('btnCamFacing'), topClass: D.$('topClass'), labelWarn: D.$('labelWarn'),
    qualityNote: D.$('qualityNote')
  };
  uiElements.ctx = uiElements.canvas.getContext('2d');

  // --- 狀態變數 ---
  let classifier, labels=[], posenetModel;
  let running = false, flip = true, facingMode = 'user';
  let displayOrder = [], idxMap = [], smooth = {}, lastStable = '';
  let lockName = '', lockCount = 0, skipMsgCooldown = 0;

  // --- 介面 & 輔助函式 ---
  uiElements.ver.textContent = `SecureContext=${window.isSecureContext} | tfjs=${(tf&&tf.version&&tf.version.tfjs)||'未載'} | backend=${tf.getBackend()||'-'}`;
  const info = (t, ok) => { uiElements.msg.className = ok===true?'ok':(ok===false?'bad':''); uiElements.msg.textContent = t; };

  // --- 事件處理 ---
  uiElements.btnCheck.onclick = async () => {
    info('');
    try {
      if (!window.isSecureContext) throw new Error('此頁面不是 HTTPS 或 localhost，瀏覽器會封鎖相機');
      const st = await navigator.mediaDevices.getUserMedia({ video:true, audio:false });
      st.getTracks().forEach(t => t.stop());
      info('✅ 相機檢測成功，可以使用', true);
    } catch (e) {
      info(`相機自檢失敗：${e.name}\n${e.message||''}\n• NotAllowedError：曾按拒絕或站點權限被關。\n• NotFoundError：沒有可用攝影機。\n• 請用 HTTPS / localhost 並允許相機。`, false);
    }
  };

  uiElements.btnFlip.onclick = () => { flip=!flip; uiElements.btnFlip.textContent=`切換鏡像：${flip?'開':'關'}`; };
  uiElements.btnCamFacing.onclick = async () => {
    facingMode = (facingMode==='user')?'environment':'user';
    uiElements.btnCamFacing.textContent=`鏡頭：${facingMode==='user'?'前':'後'}`;
    if (running) await restartStream();
  };

  uiElements.btnStart.onclick = async () => {
    try {
      info('載入中…');
      try{ await tf.setBackend('webgl'); }catch{ await tf.setBackend('cpu'); }
      await tf.ready();

      const meta = await fetch(METADATA_URL, {cache:'no-store'}).then(r => r.json());
      labels = meta.labels || meta.classes || [];
      if (!Array.isArray(labels) || labels.length === 0) throw new Error('metadata.json 缺少 labels');

      const parseD = s => { const m = /D\s*([1-8])/i.exec(s||''); return m ? (parseInt(m[1],10)-1) : -1; };
      idxMap = labels.map(parseD);
      const invalid = idxMap.some(i => i < 0) || new Set(idxMap.filter(i => i >= 0)).size < Math.min(8, labels.length);

      if (invalid) {
        displayOrder = labels.slice();
        uiElements.labelWarn.innerHTML = `⚠️ <span class="warn">有些標籤不是「D1~D8」格式，已改以模型原生 labels 顯示。</span>`;
      } else {
        displayOrder = DESIRED_8.slice();
        uiElements.labelWarn.innerHTML = `<span class="ok">✅ 已依 D1~D8 自動對齊為八段錦中文順序。</span>`;
      }

      await fetch(MODEL_URL, {cache:'no-store'}).then(r => { if(!r.ok) throw new Error(`model.json HTTP ${r.status}`); });
      classifier = await tf.loadLayersModel(MODEL_URL);
      posenetModel = await posenet.load(PNET_CFG);

      await restartStream();
      uiElements.canvas.width = 400; uiElements.canvas.height = 400;
      buildBars(displayOrder);

      info('✅ 模型載入完成，相機啟動成功！', true);
      running = true; uiElements.beat.style.visibility = 'visible';
      requestAnimationFrame(loop);
    } catch (e) {
      info('❌ 無法載入：\n' + (e.message||e.toString()), false);
      console.error(e);
    }
  };

  // --- 核心函式 ---
  async function restartStream() {
    try { const old = uiElements.video.srcObject; if(old) old.getTracks().forEach(t => t.stop()); } catch(_) {}
    const st = await navigator.mediaDevices.getUserMedia({ video:{ facingMode }, audio:false });
    uiElements.video.srcObject = st; await uiElements.video.play();
  }

  function buildBars(names) {
    uiElements.bars.innerHTML = '';
    smooth = {};
    names.forEach(n => {
      smooth[n] = 0;
      const id
